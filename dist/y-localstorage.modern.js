import*as t from"yjs";import{Observable as e}from"lib0/observable";const s=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;class o extends e{constructor(t,e,s=5){super(),this._DocPrefix=void 0,this._sharedDoc=void 0,this._UpdateCounter=1,this._CounterLimit=5,this._pendingUpdates=0,this._completedUpdates=0,this._SubDocMap=new Map,this._DocPrefix=t+"-",this._sharedDoc=e,this._UpdateCounter=0,this._CounterLimit=s;try{this._applyStoredUpdates()}catch(t){this._breakdownWith("could not restore document from persistence",t)}this._storeUpdate=this._storeUpdate.bind(this),e.on("update",this._storeUpdate),this._manageSubDocs=this._manageSubDocs.bind(this),e.on("subdocs",this._manageSubDocs),this.destroy=this.destroy.bind(this),e.on("destroy",this.destroy)}get isSynced(){return 0===this._pendingUpdates}destroy(){null!=this._sharedDoc&&(this._removeStoredUpdatesStartingWith(0),this._removeStoredSubDocs(),this._sharedDoc.off("update",this._storeUpdate),this._sharedDoc.off("subdocs",this._manageSubDocs),this._sharedDoc.off("destroy",this.destroy),this.isSynced||(this._pendingUpdates=0,this.emit("sync-aborted",[this,1])),this._sharedDoc=void 0)}static destroyPersistenceNamed(t){let e=[];for(let s=0,o=localStorage.length;s<o;s++){const o=localStorage.key(s);(o.startsWith(t+"-")||o.startsWith(t+"."))&&e.push(o)}e.forEach(t=>{localStorage.removeItem(t)})}_applyStoredUpdates(){const e=this._DocPrefix.length,s=this._StorageKeys();s.length>0?(this._pendingUpdates+=s.length,this._reportProgress(),s.forEach(s=>{let o=parseInt(s.slice(e),10);o>this._UpdateCounter&&(this._UpdateCounter=o);const i=new Uint8Array(JSON.parse(localStorage.getItem(s)));t.applyUpdate(this._sharedDoc,i,this),this._completedUpdates++,this._reportProgress()})):(this._UpdateCounter=1,this._reportProgress())}_storeUpdate(e,s){if(null!=this._sharedDoc&&s!==this){this._pendingUpdates++,this._reportProgress();try{this._UpdateCounter<this._CounterLimit?(localStorage.setItem(this._DocPrefix+this._UpdateCounter,JSON.stringify(Array.from(e))),this._UpdateCounter++):(localStorage.setItem(this._DocPrefix+0,JSON.stringify(Array.from(t.encodeStateAsUpdate(this._sharedDoc)))),this._removeStoredUpdatesStartingWith(1))}catch(t){this._breakdownWith("could not persist document update",t)}this._completedUpdates++,this._reportProgress()}}_removeStoredUpdatesStartingWith(t){const e=this._DocPrefix.length;let s;this._StorageKeys().forEach(o=>{if(parseInt(o.slice(e),10)>=t)try{localStorage.removeItem(o)}catch(t){s=t}}),null!=s&&console.warn("y-localstorage: could not clean-up localstorage, reason: "+s),this._UpdateCounter=t}_removeStoredSubDocs(){this._removeStoredSubDoc()}_removeStoredSubDoc(t){let e;(null==t?this._StorageSubKeys():this._StorageSubKeysFor(t)).forEach(t=>{try{localStorage.removeItem(t)}catch(t){e=t}}),null!=e&&console.warn("y-localstorage: could not clean-up localstorage, reason: "+e)}_breakdown(){this._sharedDoc=void 0,this.isSynced||(this._pendingUpdates=0,this.emit("sync-aborted",[this,1])),this._SubDocMap.forEach(t=>t._breakdown())}_breakdownWith(t,e){throw this._breakdown(),new Error(t+(null==e?"":", reason: "+e))}_manageSubDocs(t){const e=t=>{if(!this._SubDocMap.has(t)&&this._sharedDoc.guid!==t.guid){const e=new o(this._DocPrefix.slice(0,-1)+"."+t.guid,t,this._CounterLimit);this._SubDocMap.set(t,e)}},{removed:s,loaded:i}=t;null!=s&&s.forEach(t=>{const e=this._SubDocMap.get(t);null!=e&&e._breakdown(),this._SubDocMap.delete(t),null!=this._sharedDoc&&this._sharedDoc.guid!==t.guid&&Array.from(this._sharedDoc.getSubdocs().values()).every(e=>e.guid!==t.guid)&&this._removeStoredSubDoc(t)}),null!=i&&i.forEach(t=>{e(t)})}_reportProgress(){switch(!0){case 0===this._pendingUpdates:this._completedUpdates=0,this.emit("synced",[this]);break;case 0===this._completedUpdates:this.emit("sync-started",[this,0]);break;case this._completedUpdates===this._pendingUpdates:this.emit("sync-finished",[this,1]),this._pendingUpdates=this._completedUpdates=0,this.emit("synced",[this]);break;default:this.emit("sync-continued",[this,this._completedUpdates/this._pendingUpdates])}}_StorageKeys(){return this._StorageSubKeysFor()}_StorageSubKeys(){const t=this._DocPrefix.slice(0,-1)+".",e=t.length,o=[];for(let i=0,r=localStorage.length;i<r;i++){const r=localStorage.key(i);r.startsWith(t)&&!0===s.test(r.slice(e))&&o.push(r)}return o}_StorageSubKeysFor(t){const e=null==t?this._DocPrefix:this._DocPrefix.slice(0,-1)+"."+t.guid+"-",s=e.length,o=[];for(let t=0,i=localStorage.length;t<i;t++){const i=localStorage.key(t);i.startsWith(e)&&!0===/^\d+$/.test(i.slice(s))&&o.push(i)}return o}}export{o as LocalStorageProvider};
//# sourceMappingURL=y-localstorage.modern.js.map
